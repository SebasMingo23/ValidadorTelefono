function wsforms_email_validation() {
    ?>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üìß Validaci√≥n de Email activada...");

            function attachEmailValidation(emailField) {
                if (emailField.hasAttribute("data-validated")) return; // Evita validaciones duplicadas

                const form = emailField.closest("form");
                let isValidEmail = false;

                // Expresi√≥n regular mejorada para validar emails
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

                // Lista de dominios restringidos
                const restrictedDomains = [
                    "test.com", "example.com", "email.com", "mail.com",
                    "fake.com", "demo.com", "prueba.com"
                ];

                emailField.placeholder = "Ej: usuario@ejemplo.com";

                // Crear mensaje de advertencia
                let warningMessage = document.createElement("span");
                warningMessage.style.color = "#e74c3c"; // Rojo notorio
                warningMessage.style.fontSize = "14px";
                warningMessage.style.marginTop = "5px";
                warningMessage.style.display = "none";
                warningMessage.innerHTML = "‚ö†Ô∏è Ingres√° un email v√°lido.";

                emailField.parentNode.appendChild(warningMessage);

                // Funci√≥n de validaci√≥n
                emailField.addEventListener("blur", function () {
                    let emailValue = emailField.value.trim();
                    console.log("üìß Validando email:", emailValue);

                    if (emailValue.length === 0) {
                        isValidEmail = false;
                        warningMessage.style.display = "none";
                        emailField.style.border = "2px solid #ccc";
                        return;
                    }

                    if (emailRegex.test(emailValue)) {
                        let emailParts = emailValue.split("@");

                        // Verifica si hay al menos un texto antes del @
                        if (emailParts.length !== 2 || emailParts[0].length === 0) {
                            console.warn("‚õî Formato inv√°lido: falta usuario antes del @");
                            warningMessage.innerHTML = "‚ö†Ô∏è El email debe tener un usuario antes del @.";
                            warningMessage.style.display = "block";
                            emailField.style.border = "2px solid red";
                            isValidEmail = false;
                            return;
                        }

                        let emailDomain = emailParts[1].toLowerCase();

                        // Evitar dominios repetidos como "gmail.com.com"
                        let domainParts = emailDomain.split(".");
                        if (
                            domainParts.length > 2 &&
                            domainParts[domainParts.length - 1] === domainParts[domainParts.length - 2]
                        ) {
                            console.warn("‚õî Dominio inv√°lido repetido:", emailDomain);
                            warningMessage.innerHTML = `‚ö†Ô∏è El dominio <strong>${emailDomain}</strong> no es v√°lido.`;
                            warningMessage.style.display = "block";
                            emailField.style.border = "2px solid red";
                            isValidEmail = false;
                            return;
                        }

                        // Evitar dominios de prueba o bloqueados
                        if (restrictedDomains.includes(emailDomain)) {
                            console.warn("‚õî Dominio restringido:", emailDomain);
                            warningMessage.innerHTML = `‚ö†Ô∏è No se permiten emails con el dominio <strong>${emailDomain}</strong>.`;
                            warningMessage.style.display = "block";
                            emailField.style.border = "2px solid red";
                            isValidEmail = false;
                            return;
                        }

                        // Evitar m√°s de un punto seguido en el dominio (ejemplo@empresa..com)
                        if (emailDomain.includes("..")) {
                            console.warn("‚õî Dominio inv√°lido con puntos repetidos:", emailDomain);
                            warningMessage.innerHTML = `‚ö†Ô∏è El dominio <strong>${emailDomain}</strong> no puede contener "..".`;
                            warningMessage.style.display = "block";
                            emailField.style.border = "2px solid red";
                            isValidEmail = false;
                            return;
                        }

                        // Validar que la √∫ltima parte del dominio tenga al menos 2 caracteres (ej: ".c" no es v√°lido)
                        let topLevelDomain = domainParts[domainParts.length - 1];
                        if (topLevelDomain.length < 2) {
                            console.warn("‚õî TLD inv√°lido:", topLevelDomain);
                            warningMessage.innerHTML = `‚ö†Ô∏è El dominio debe terminar con una extensi√≥n v√°lida (ej: .com, .net, .org).`;
                            warningMessage.style.display = "block";
                            emailField.style.border = "2px solid red";
                            isValidEmail = false;
                            return;
                        }

                        console.log("‚úÖ Email v√°lido.");
                        isValidEmail = true;
                        warningMessage.style.display = "none";
                        emailField.style.border = "2px solid green";
                    } else {
                        console.warn("‚ùå Email inv√°lido.");
                        warningMessage.innerHTML = "‚ö†Ô∏è Ingres√° un email v√°lido.";
                        warningMessage.style.display = "block";
                        emailField.style.border = "2px solid red";
                        isValidEmail = false;
                    }
                });

                // Bloquear el env√≠o del formulario si el email es inv√°lido
                form.addEventListener("submit", function (event) {
                    console.log("üîç Verificando antes del env√≠o. Email v√°lido:", isValidEmail);

                    if (!isValidEmail) {
                        event.preventDefault();
                        event.stopImmediatePropagation(); // Evita que WS Forms lo procese
                        warningMessage.style.display = "block";
                        emailField.style.border = "2px solid red";
                        console.warn("‚õî Env√≠o bloqueado: email inv√°lido o dominio restringido.");
                        return false;
                    }
                }, true);

                emailField.setAttribute("data-validated", "true"); // Marcar el campo como validado
            }

            // Observar el DOM para encontrar campos de email din√°micos
            function waitForEmailFields() {
                let observer = new MutationObserver(() => {
                    let emailFields = document.querySelectorAll("input[type='email'], input[name*='email']");
                    emailFields.forEach(emailField => attachEmailValidation(emailField));
                });

                observer.observe(document.body, { childList: true, subtree: true });
            }

            waitForEmailFields();
        });
    </script>
    <?php
}
add_action('wp_footer', 'wsforms_email_validation');
